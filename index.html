<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Splitly - Expense Splitter</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #f8f9fa;
            color: #000;
            line-height: 1.6;
        }
        
        .header {
            background: #fff;
            border-bottom: 1px solid #dee2e6;
            padding: 0 2rem;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .logo-icon {
            width: 36px;
            height: 36px;
            background: #000;
            color: #fff;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .nav-btn {
            padding: 0.5rem 1rem;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        
        .nav-btn:hover {
            background: #e9ecef;
        }
        
        .nav-btn.active {
            background: #000;
            color: #fff;
            border-color: #000;
        }
        
        .user-badge {
            background: #f8f9fa;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .group-selector {
            background: #fff;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .group-select, .currency-select {
            flex: 1;
            min-width: 200px;
            padding: 0.75rem 1rem;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-family: inherit;
            cursor: pointer;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            background: #000;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: transform 0.2s;
        }
        
        .btn:hover { transform: translateY(-1px); }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #000;
            border: 1px solid #dee2e6;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        .participants-expense-column {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .card {
            background: #fff;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .form-group {
            margin-bottom: 1.25rem;
        }
        
        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }
        
        input, select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-family: inherit;
        }
        
        .people-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .person-chip {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .remove-person {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            font-size: 1.125rem;
            margin-left: 0.5rem;
        }
        
        .expense-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .expense-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 1.25rem;
        }
        
        .expense-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        
        .expense-desc {
            font-size: 1rem;
            font-weight: 600;
        }
        
        .expense-meta {
            font-size: 0.8125rem;
            color: #495057;
            margin-top: 0.25rem;
        }
        
        .expense-amount {
            font-size: 1.25rem;
            font-weight: 700;
        }
        
        .expense-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #dee2e6;
        }
        
        .icon-btn {
            padding: 0.5rem 1rem;
            background: #e9ecef;
            border: none;
            border-radius: 6px;
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            color: #495057;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .summary-card {
            background: #000;
            color: #fff;
            padding: 1.5rem;
            border-radius: 12px;
        }
        
        .summary-label {
            font-size: 0.75rem;
            opacity: 0.7;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        
        .summary-value {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .chart-container {
            margin: 1.5rem 0;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 12px;
        }
        
        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #495057;
        }
        
        .chart-bars {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .chart-bar {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .chart-label {
            min-width: 100px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .chart-bar-bg {
            flex: 1;
            height: 32px;
            background: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .chart-bar-fill {
            height: 100%;
            background: #000;
            border-radius: 6px;
            transition: width 0.6s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.75rem;
        }
        
        .chart-value {
            font-size: 0.75rem;
            font-weight: 600;
            color: #fff;
        }
        
        .settlement-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .settlement-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 1.25rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .settlement-from, .settlement-to {
            font-weight: 700;
        }
        
        .settlement-arrow {
            font-size: 1.25rem;
            color: #6c757d;
        }
        
        .settlement-amount {
            margin-left: auto;
            font-weight: 700;
            font-size: 1.125rem;
        }
        
        .checklist-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 1.25rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .checklist-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }
        
        .checklist-content {
            flex: 1;
        }
        
        .checklist-desc {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .checklist-meta {
            font-size: 0.8125rem;
            color: #6c757d;
        }
        
        .checklist-item.completed {
            opacity: 0.6;
            text-decoration: line-through;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1.5rem;
        }
        
        .modal {
            background: #fff;
            border-radius: 16px;
            padding: 2.5rem;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }
        
        .modal-icon {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-title {
            font-size: 1.75rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 0.75rem;
        }
        
        .modal-subtitle {
            font-size: 0.9375rem;
            text-align: center;
            color: #495057;
            margin-bottom: 2rem;
        }
        
        .modal-input {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            background: #f8f9fa;
            margin-bottom: 1.5rem;
        }
        
        .modal-btn {
            width: 100%;
            padding: 1rem;
            background: #000;
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        .qr-container {
            text-align: center;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }
        
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #000;
            color: #fff;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1.5rem;
            color: #6c757d;
        }
        
        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-text {
            font-size: 0.9375rem;
            font-weight: 500;
        }
        
        .footer {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
            font-size: 0.75rem;
            border-top: 1px solid #dee2e6;
            margin-top: 3rem;
        }
        
        .hidden { display: none !important; }
        
        @media (max-width: 1024px) {
            .grid { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 768px) {
            .header { padding: 1rem; flex-wrap: wrap; }
            .header-right { width: 100%; justify-content: space-between; margin-top: 0.5rem; }
            .container { padding: 1rem; }
            .group-selector { flex-direction: column; }
            .card { padding: 1.5rem; }
            .summary-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="modal-overlay" id="welcomeModal">
        <div class="modal">
            <div class="modal-icon">üëã</div>
            <h1 class="modal-title">Welcome to Splitly</h1>
            <p class="modal-subtitle">Smart expense splitting made simple</p>
            <input type="text" id="userName" class="modal-input" placeholder="Enter your name" onkeypress="if(event.key==='Enter') saveUserName()">
            <button class="modal-btn" onclick="saveUserName()">Get Started</button>
        </div>
    </div>

    <div class="modal-overlay hidden" id="qrModal">
        <div class="modal">
            <div class="modal-icon">üì±</div>
            <h2 class="modal-title">Share via QR Code</h2>
            <p class="modal-subtitle">Scan to view the split summary</p>
            <div class="qr-container" id="qrCode"></div>
            <button class="modal-btn" onclick="closeQRModal()">Close</button>
        </div>
    </div>

    <div class="modal-overlay hidden" id="groupModal">
        <div class="modal">
            <div class="modal-icon">üë•</div>
            <h2 class="modal-title">Create New Group</h2>
            <p class="modal-subtitle">Enter a name for your expense group</p>
            <input type="text" id="groupName" class="modal-input" placeholder="e.g., Girls Trip, Office Lunch" onkeypress="if(event.key==='Enter') createGroup()">
            <button class="modal-btn" onclick="createGroup()">Create Group</button>
        </div>
    </div>

    <div id="app" class="hidden">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">$</div>
                Splitly
            </div>
            <div class="header-right">
                <button class="nav-btn active" id="expensesTab" onclick="showTab('expenses')">
                    <span>üí≥</span> Expenses
                </button>
                <button class="nav-btn" id="checklistTab" onclick="showTab('checklist')">
                    <span>‚úì</span> Checklist
                </button>
                <div class="user-badge">
                    <span>üë§</span>
                    <span id="displayUserName"></span>
                </div>
            </div>
        </header>

        <div class="container">
            <div id="expensesView">
                <div class="group-selector">
                    <select class="group-select" id="groupSelect" onchange="switchGroup()">
                        <option value="default">Default Group</option>
                    </select>
                    <button class="btn" onclick="showGroupModal()">
                        <span>‚ûï</span> New Group
                    </button>
                    <select class="currency-select" id="currencySelect" onchange="changeCurrency()">
                        <option value="USD">üí± USD</option>
                        <option value="EUR">üí± EUR</option>
                        <option value="GBP">üí± GBP</option>
                        <option value="AUD">üí± AUD</option>
                        <option value="CAD">üí± CAD</option>
                        <option value="JPY">üí± JPY</option>
                        <option value="INR">üí± INR</option>
                        <option value="CNY">üí± CNY</option>
                        <option value="CHF">üí± CHF</option>
                        <option value="MXN">üí± MXN</option>
                        <option value="BRL">üí± BRL</option>
                        <option value="SGD">üí± SGD</option>
                    </select>
                </div>

                <div class="grid">
                    <div class="participants-expense-column">
                        <div class="card">
                            <h2 class="card-title"><span>üë•</span> Participants</h2>
                            <div class="form-group">
                                <label>Add Person</label>
                                <input type="text" id="personName" placeholder="Enter name" onkeypress="if(event.key==='Enter') addPerson()">
                            </div>
                            <button class="btn" style="width: 100%;" onclick="addPerson()">
                                <span>‚ûï</span> Add Person
                            </button>
                            <div id="peopleList" class="people-list"></div>
                        </div>

                        <div class="card">
                            <h2 class="card-title"><span>üí≥</span> Add Expense</h2>
                            <div class="form-group">
                                <label>Description</label>
                                <input type="text" id="expenseDesc" placeholder="e.g., Dinner">
                            </div>
                            <div class="form-group">
                                <label>Amount</label>
                                <input type="number" id="expenseAmount" placeholder="0.00" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Who Paid?</label>
                                <select id="whoPaid"></select>
                            </div>
                            <button class="btn" style="width: 100%;" onclick="addExpense()" id="expenseSubmitBtn">
                                <span>‚ûï</span> Add Expense
                            </button>
                        </div>

                        <div class="card">
                            <h2 class="card-title"><span>üßæ</span> Expenses</h2>
                            <div class="expense-list" id="expensesList">
                                <div class="empty-state">
                                    <div class="empty-icon">üí∞</div>
                                    <div class="empty-text">No expenses added yet</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="card">
                            <h2 class="card-title"><span>üìä</span> Summary</h2>
                            <div class="summary-grid">
                                <div class="summary-card">
                                    <div class="summary-label">Total Spent</div>
                                    <div class="summary-value" id="totalSpent">$0.00</div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-label">Per Person</div>
                                    <div class="summary-value" id="perPerson">$0.00</div>
                                </div>
                            </div>

                            <div class="chart-container">
                                <div class="chart-title">Spending Overview</div>
                                <div class="chart-bars" id="chartBars">
                                    <div class="empty-state">
                                        <div class="empty-icon">üìä</div>
                                        <div class="empty-text">Add expenses to see chart</div>
                                    </div>
                                </div>
                            </div>

                            <button class="btn" style="width: 100%;" onclick="calculateSplit()">
                                <span>üî¢</span> Calculate Split
                            </button>
                        </div>

                        <div class="card hidden" id="settlementsCard">
                            <h2 class="card-title"><span>üí∏</span> Who Owes Whom</h2>
                            <div class="settlement-list" id="settlementsList"></div>
                        </div>

                        <div class="card hidden" id="shareCard">
                            <h2 class="card-title"><span>üîó</span> Share Results</h2>
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn btn-secondary" style="flex: 1;" onclick="shareLink()">
                                    <span>üìã</span> Copy Link
                                </button>
                                <button class="btn btn-secondary" style="flex: 1;" onclick="generateQR()">
                                    <span>üì±</span> QR Code
                                </button>
                            </div>
                        </div>

                        <div class="card">
                            <h2 class="card-title"><span>üìú</span> Payment History</h2>
                            <div id="paymentHistory">
                                <div class="empty-state">
                                    <div class="empty-icon">üí≥</div>
                                    <div class="empty-text">No payments recorded yet</div>
                                </div>
                            </div>
                            <button class="btn btn-secondary hidden" style="width: 100%; margin-top: 1rem;" onclick="clearHistory()" id="clearHistoryBtn">
                                <span>üóëÔ∏è</span> Clear History
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="checklistView" class="hidden">
                <div class="card" style="margin-top: 2rem;">
                    <h2 class="card-title"><span>‚úì</span> Payment Checklist</h2>
                    <div id="checklistContainer">
                        <div class="empty-state">
                            <div class="empty-icon">üìù</div>
                            <div class="empty-text">No items in checklist yet. Add from settlements!</div>
                        </div>
                    </div>
                    <button class="btn btn-secondary hidden" style="width: 100%; margin-top: 1rem;" onclick="clearChecklist()" id="clearChecklistBtn">
                        <span>üóëÔ∏è</span> Clear Checklist
                    </button>
                </div>
            </div>

            <div class="footer">
                ~By Anvi Karanjkar~
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        let currentUser = '';
        let currentGroup = 'default';
        let currentCurrency = 'USD';
        let groups = {};
        let editingExpenseId = null;
        let checklist = [];
        let currentView = 'expenses';

        const currencyRates = {
            USD: 1, EUR: 0.92, GBP: 0.79, AUD: 1.52, CAD: 1.36, JPY: 149.5,
            INR: 83.12, CNY: 7.24, CHF: 0.88, MXN: 17.25, BRL: 4.97, SGD: 1.34
        };

        const currencySymbols = {
            USD: '$', EUR: '‚Ç¨', GBP: '¬£', AUD: 'A$', CAD: 'C$', JPY: '¬•',
            INR: '‚Çπ', CNY: '¬•', CHF: 'Fr', MXN: 'Mex$', BRL: 'R$', SGD: 'S$'
        };

        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const sharedData = urlParams.get('data');
            if (sharedData) {
                loadSharedData(sharedData);
                return;
            }
            loadFromStorage();
            if (currentUser) {
                document.getElementById('welcomeModal').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                document.getElementById('displayUserName').textContent = currentUser;
                renderAll();
            }
        }

        function saveToStorage() {
            const data = JSON.stringify({
                currentUser, currentGroup, currentCurrency, groups, checklist
            });
            try {
                localStorage.setItem('splitlyData', data);
            } catch (e) {
                console.error('Storage error:', e);
            }
        }

        function loadFromStorage() {
            try {
                const stored = localStorage.getItem('splitlyData');
                if (stored) {
                    const data = JSON.parse(stored);
                    currentUser = data.currentUser || '';
                    currentGroup = data.currentGroup || 'default';
                    currentCurrency = data.currentCurrency || 'USD';
                    groups = data.groups || {};
                    checklist = data.checklist || [];
                    if (!groups.default) initializeDefaultGroup();
                } else {
                    initializeDefaultGroup();
                }
            } catch (e) {
                initializeDefaultGroup();
            }
        }

        function initializeDefaultGroup() {
            groups = {
                default: {
                    name: 'Default Group',
                    people: currentUser ? [currentUser] : [],
                    expenses: [],
                    paymentHistory: []
                }
            };
        }

        function saveUserName() {
            const name = document.getElementById('userName').value.trim();
            if (!name) {
                showToast('‚ö†Ô∏è', 'Please enter your name');
                return;
            }
            currentUser = name;
            initializeDefaultGroup();
            groups.default.people.push(name);
            saveToStorage();
            document.getElementById('welcomeModal').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('displayUserName').textContent = name;
            renderAll();
        }

        function showTab(tab) {
            currentView = tab;
            document.getElementById('expensesTab').classList.toggle('active', tab === 'expenses');
            document.getElementById('checklistTab').classList.toggle('active', tab === 'checklist');
            document.getElementById('expensesView').classList.toggle('hidden', tab !== 'expenses');
            document.getElementById('checklistView').classList.toggle('hidden', tab !== 'checklist');
            
            if (tab === 'checklist') {
                renderChecklist();
            }
        }

        function showGroupModal() {
            document.getElementById('groupModal').classList.remove('hidden');
            document.getElementById('groupName').focus();
        }

        function createGroup() {
            const name = document.getElementById('groupName').value.trim();
            if (!name) {
                showToast('‚ö†Ô∏è', 'Please enter a group name');
                return;
            }
            const groupId = 'group_' + Date.now();
            const currentGroupData = getCurrentGroup();
            groups[groupId] = {
                name: name,
                people: [...currentGroupData.people],
                expenses: [],
                paymentHistory: []
            };
            currentGroup = groupId;
            saveToStorage();
            renderGroupSelector();
            document.getElementById('groupModal').classList.add('hidden');
            document.getElementById('groupName').value = '';
            resetSummary();
            renderAll();
            showToast('‚úÖ', 'Group "' + name + '" created');
        }

        function switchGroup() {
            currentGroup = document.getElementById('groupSelect').value;
            saveToStorage();
            resetSummary();
            renderAll();
            const groupName = getCurrentGroup().name;
            showToast('‚úÖ', 'Switched to ' + groupName);
        }

        function resetSummary() {
            document.getElementById('totalSpent').textContent = formatCurrency(0);
            document.getElementById('perPerson').textContent = formatCurrency(0);
            document.getElementById('settlementsCard').classList.add('hidden');
            document.getElementById('shareCard').classList.add('hidden');
        }

        function getCurrentGroup() {
            return groups[currentGroup] || groups.default;
        }

        function renderGroupSelector() {
            const select = document.getElementById('groupSelect');
            select.innerHTML = Object.entries(groups).map(([id, group]) => 
                '<option value="' + id + '"' + (id === currentGroup ? ' selected' : '') + '>' + escapeHtml(group.name) + '</option>'
            ).join('');
        }

        function changeCurrency() {
            currentCurrency = document.getElementById('currencySelect').value;
            saveToStorage();
            renderAll();
            showToast('‚úÖ', 'Currency changed to ' + currentCurrency);
        }

        function formatCurrency(amount) {
            const symbol = currencySymbols[currentCurrency];
            if (currentCurrency === 'JPY') {
                return symbol + Math.round(amount).toLocaleString();
            }
            return symbol + amount.toFixed(2);
        }

        function addPerson() {
            const name = document.getElementById('personName').value.trim();
            if (!name) {
                showToast('‚ö†Ô∏è', 'Please enter a name');
                return;
            }
            const group = getCurrentGroup();
            if (group.people.includes(name)) {
                showToast('‚ö†Ô∏è', 'Person already added');
                return;
            }
            group.people.push(name);
            document.getElementById('personName').value = '';
            saveToStorage();
            renderAll();
            showToast('‚úÖ', name + ' added');
        }

        function removePerson(name) {
            const group = getCurrentGroup();
            const hasExpenses = group.expenses.some(e => e.payer === name);
            if (hasExpenses) {
                showToast('‚ö†Ô∏è', 'Cannot remove - person has expenses');
                return;
            }
            group.people = group.people.filter(p => p !== name);
            saveToStorage();
            renderAll();
            showToast('‚úÖ', name + ' removed');
        }

        function addExpense() {
            const desc = document.getElementById('expenseDesc').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const payer = document.getElementById('whoPaid').value;
            if (!desc) {
                showToast('‚ö†Ô∏è', 'Please enter a description');
                return;
            }
            if (!amount || amount <= 0) {
                showToast('‚ö†Ô∏è', 'Please enter a valid amount');
                return;
            }
            if (!payer) {
                showToast('‚ö†Ô∏è', 'Please select who paid');
                return;
            }
            const group = getCurrentGroup();
            const expense = {
                id: editingExpenseId || Date.now(),
                description: desc,
                amount: amount,
                payer: payer,
                currency: currentCurrency,
                timestamp: Date.now()
            };
            if (editingExpenseId) {
                const index = group.expenses.findIndex(e => e.id === editingExpenseId);
                group.expenses[index] = expense;
                editingExpenseId = null;
                showToast('‚úÖ', 'Expense updated');
                document.getElementById('expenseSubmitBtn').innerHTML = '<span>‚ûï</span> Add Expense';
            } else {
                group.expenses.push(expense);
                showToast('‚úÖ', 'Expense added');
            }
            document.getElementById('expenseDesc').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('whoPaid').value = currentUser;
            saveToStorage();
            renderAll();
        }

        function editExpense(id) {
            const group = getCurrentGroup();
            const expense = group.expenses.find(e => e.id === id);
            if (!expense) return;
            editingExpenseId = id;
            document.getElementById('expenseDesc').value = expense.description;
            document.getElementById('expenseAmount').value = expense.amount;
            document.getElementById('whoPaid').value = expense.payer;
            document.getElementById('expenseSubmitBtn').innerHTML = '<span>‚úèÔ∏è</span> Update Expense';
            document.querySelector('.participants-expense-column').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }

        function deleteExpense(id) {
            if (!confirm('Delete this expense?')) return;
            const group = getCurrentGroup();
            group.expenses = group.expenses.filter(e => e.id !== id);
            saveToStorage();
            renderAll();
            showToast('‚úÖ', 'Expense deleted');
        }

        function calculateSplit() {
            const group = getCurrentGroup();
            if (group.people.length === 0) {
                showToast('‚ö†Ô∏è', 'Add people first');
                return;
            }
            if (group.expenses.length === 0) {
                showToast('‚ö†Ô∏è', 'Add expenses first');
                return;
            }
            const totalSpent = group.expenses.reduce((sum, e) => sum + e.amount, 0);
            document.getElementById('totalSpent').textContent = formatCurrency(totalSpent);
            const balances = {};
            group.people.forEach(p => balances[p] = 0);
            group.expenses.forEach(expense => {
                const perPerson = expense.amount / group.people.length;
                balances[expense.payer] += expense.amount;
                group.people.forEach(person => {
                    balances[person] -= perPerson;
                });
            });
            group.paymentHistory.forEach(payment => {
                if (balances.hasOwnProperty(payment.from) && balances.hasOwnProperty(payment.to)) {
                    balances[payment.from] += payment.amount;
                    balances[payment.to] -= payment.amount;
                }
            });
            const avgPerPerson = totalSpent / group.people.length;
            document.getElementById('perPerson').textContent = formatCurrency(avgPerPerson);
            const settlements = calculateSettlements(balances);
            displaySettlements(settlements);
            renderChart();
            document.getElementById('shareCard').classList.remove('hidden');
            showToast('‚úÖ', 'Split calculated successfully');
        }

        function calculateSettlements(balances) {
            const creditors = [];
            const debtors = [];
            for (const [person, balance] of Object.entries(balances)) {
                if (balance > 0.01) {
                    creditors.push({ person, amount: balance });
                } else if (balance < -0.01) {
                    debtors.push({ person, amount: -balance });
                }
            }
            creditors.sort((a, b) => b.amount - a.amount);
            debtors.sort((a, b) => b.amount - a.amount);
            const settlements = [];
            let i = 0, j = 0;
            while (i < debtors.length && j < creditors.length) {
                const debtor = debtors[i];
                const creditor = creditors[j];
                const amount = Math.min(debtor.amount, creditor.amount);
                settlements.push({
                    from: debtor.person,
                    to: creditor.person,
                    amount: amount
                });
                debtor.amount -= amount;
                creditor.amount -= amount;
                if (debtor.amount < 0.01) i++;
                if (creditor.amount < 0.01) j++;
            }
            return settlements;
        }

        function displaySettlements(settlements) {
            const list = document.getElementById('settlementsList');
            const card = document.getElementById('settlementsCard');
            if (settlements.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div class="empty-text">Everyone is settled up!</div></div>';
            } else {
                list.innerHTML = settlements.map(s => 
                    '<div class="settlement-item">' +
                    '<span class="settlement-from">' + escapeHtml(s.from) + '</span>' +
                    '<span class="settlement-arrow">‚Üí</span>' +
                    '<span class="settlement-to">' + escapeHtml(s.to) + '</span>' +
                    '<span class="settlement-amount">' + formatCurrency(s.amount) + '</span>' +
                    '<button class="icon-btn" onclick="addToChecklist(\'' + escapeHtml(s.from) + '\', \'' + escapeHtml(s.to) + '\', ' + s.amount + ')">‚ûï Checklist</button>' +
                    '<button class="icon-btn" onclick="markAsPaid(\'' + escapeHtml(s.from) + '\', \'' + escapeHtml(s.to) + '\', ' + s.amount + ')">‚úì Paid</button>' +
                    '</div>'
                ).join('');
            }
            card.classList.remove('hidden');
        }

        function addToChecklist(from, to, amount) {
            const existingItem = checklist.find(item => 
                item.from === from && item.to === to && !item.completed
            );
            if (existingItem) {
                showToast('‚ö†Ô∏è', 'Already in checklist');
                return;
            }
            checklist.push({
                id: Date.now(),
                from: from,
                to: to,
                amount: amount,
                currency: currentCurrency,
                group: getCurrentGroup().name,
                completed: false,
                timestamp: Date.now()
            });
            saveToStorage();
            showToast('‚úÖ', 'Added to checklist');
        }

        function renderChecklist() {
            const container = document.getElementById('checklistContainer');
            const clearBtn = document.getElementById('clearChecklistBtn');
            if (checklist.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìù</div><div class="empty-text">No items in checklist yet. Add from settlements!</div></div>';
                clearBtn.classList.add('hidden');
                return;
            }
            const sorted = [...checklist].sort((a, b) => a.completed - b.completed || b.timestamp - a.timestamp);
            container.innerHTML = sorted.map(item => 
                '<div class="checklist-item' + (item.completed ? ' completed' : '') + '">' +
                '<input type="checkbox" class="checklist-checkbox" ' + (item.completed ? 'checked' : '') + ' onchange="toggleChecklistItem(' + item.id + ')">' +
                '<div class="checklist-content">' +
                '<div class="checklist-desc">' + escapeHtml(item.from) + ' ‚Üí ' + escapeHtml(item.to) + ': ' + formatCurrencyForItem(item.amount, item.currency) + '</div>' +
                '<div class="checklist-meta">Group: ' + escapeHtml(item.group) + '</div>' +
                '</div>' +
                '<button class="icon-btn" onclick="removeFromChecklist(' + item.id + ')">üóëÔ∏è</button>' +
                '</div>'
            ).join('');
            clearBtn.classList.remove('hidden');
        }

        function formatCurrencyForItem(amount, currency) {
            const symbol = currencySymbols[currency];
            const converted = amount * currencyRates[currency];
            if (currency === 'JPY') {
                return symbol + Math.round(converted).toLocaleString();
            }
            return symbol + converted.toFixed(2);
        }

        function toggleChecklistItem(id) {
            const item = checklist.find(i => i.id === id);
            if (item) {
                item.completed = !item.completed;
                saveToStorage();
                renderChecklist();
            }
        }

        function removeFromChecklist(id) {
            if (!confirm('Remove this item from checklist?')) return;
            checklist = checklist.filter(item => item.id !== id);
            saveToStorage();
            renderChecklist();
            showToast('‚úÖ', 'Removed from checklist');
        }

        function clearChecklist() {
            if (!confirm('Clear entire checklist? This cannot be undone.')) return;
            checklist = [];
            saveToStorage();
            renderChecklist();
            showToast('‚úÖ', 'Checklist cleared');
        }

        function renderChart() {
            const group = getCurrentGroup();
            const chartBars = document.getElementById('chartBars');
            if (group.expenses.length === 0) {
                chartBars.innerHTML = '<div class="empty-state"><div class="empty-icon">üìä</div><div class="empty-text">Add expenses to see chart</div></div>';
                return;
            }
            const paidAmounts = {};
            group.people.forEach(p => paidAmounts[p] = 0);
            group.expenses.forEach(expense => {
                paidAmounts[expense.payer] += expense.amount;
            });
            const maxAmount = Math.max(...Object.values(paidAmounts));
            chartBars.innerHTML = Object.entries(paidAmounts)
                .sort((a, b) => b[1] - a[1])
                .map(([person, amount]) => {
                    const percentage = maxAmount > 0 ? (amount / maxAmount) * 100 : 0;
                    return '<div class="chart-bar">' +
                        '<div class="chart-label">' + escapeHtml(person) + '</div>' +
                        '<div class="chart-bar-bg">' +
                        '<div class="chart-bar-fill" style="width: ' + percentage + '%">' +
                        '<span class="chart-value">' + formatCurrency(amount) + '</span>' +
                        '</div></div></div>';
                }).join('');
        }

        function markAsPaid(from, to, amount) {
            if (!confirm('Mark payment of ' + formatCurrency(amount) + ' from ' + from + ' to ' + to + ' as paid?')) return;
            const group = getCurrentGroup();
            group.paymentHistory.push({
                from: from,
                to: to,
                amount: amount,
                date: new Date().toISOString(),
                timestamp: Date.now()
            });
            saveToStorage();
            showToast('‚úÖ', 'Payment marked as paid');
            calculateSplit();
            renderPaymentHistory();
        }

        function renderPaymentHistory() {
            const group = getCurrentGroup();
            const container = document.getElementById('paymentHistory');
            const clearBtn = document.getElementById('clearHistoryBtn');
            if (group.paymentHistory.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üí≥</div><div class="empty-text">No payments recorded yet</div></div>';
                clearBtn.classList.add('hidden');
                return;
            }
            const sorted = [...group.paymentHistory].sort((a, b) => b.timestamp - a.timestamp);
            container.innerHTML = sorted.map(payment => {
                const date = new Date(payment.date);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                return '<div class="settlement-item" style="margin-bottom: 0.75rem;">' +
                    '<span style="font-size: 0.75rem; color: #6c757d; min-width: 140px;">' + dateStr + '</span>' +
                    '<span class="settlement-from">' + escapeHtml(payment.from) + '</span>' +
                    '<span class="settlement-arrow">‚Üí</span>' +
                    '<span class="settlement-to">' + escapeHtml(payment.to) + '</span>' +
                    '<span class="settlement-amount">' + formatCurrency(payment.amount) + '</span>' +
                    '</div>';
            }).join('');
            clearBtn.classList.remove('hidden');
        }

        function clearHistory() {
            if (!confirm('Clear all payment history? This cannot be undone.')) return;
            const group = getCurrentGroup();
            group.paymentHistory = [];
            saveToStorage();
            renderPaymentHistory();
            showToast('‚úÖ', 'Payment history cleared');
            if (group.expenses.length > 0) {
                calculateSplit();
            }
        }

        function shareLink() {
            const data = { currentUser, currentGroup, currentCurrency, groups };
            const encoded = btoa(encodeURIComponent(JSON.stringify(data)));
            const url = window.location.origin + window.location.pathname + '?data=' + encoded;
            navigator.clipboard.writeText(url).then(() => {
                showToast('‚úÖ', 'Link copied to clipboard');
            }).catch(() => {
                const input = document.createElement('input');
                input.value = url;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                showToast('‚úÖ', 'Link copied to clipboard');
            });
        }

        function generateQR() {
            const data = { currentUser, currentGroup, currentCurrency, groups };
            const encoded = btoa(encodeURIComponent(JSON.stringify(data)));
            const url = window.location.origin + window.location.pathname + '?data=' + encoded;
            const qrContainer = document.getElementById('qrCode');
            qrContainer.innerHTML = '';
            try {
                new QRCode(qrContainer, {
                    text: url,
                    width: 256,
                    height: 256,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                document.getElementById('qrModal').classList.remove('hidden');
            } catch (e) {
                showToast('‚ö†Ô∏è', 'Failed to generate QR code');
            }
        }

        function closeQRModal() {
            document.getElementById('qrModal').classList.add('hidden');
        }

        function loadSharedData(encodedData) {
            try {
                const decoded = JSON.parse(decodeURIComponent(atob(encodedData)));
                currentUser = decoded.currentUser;
                currentGroup = decoded.currentGroup;
                currentCurrency = decoded.currentCurrency || 'USD';
                groups = decoded.groups;
                document.getElementById('welcomeModal').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                document.getElementById('displayUserName').textContent = currentUser;
                document.getElementById('currencySelect').value = currentCurrency;
                renderGroupSelector();
                renderAll();
                if (getCurrentGroup().expenses.length > 0) {
                    calculateSplit();
                }
                showToast('‚úÖ', 'Shared data loaded');
            } catch (e) {
                showToast('‚ö†Ô∏è', 'Invalid share link');
            }
        }

        function renderAll() {
            renderGroupSelector();
            renderPeople();
            renderWhoPaidDropdown();
            renderExpenses();
            renderPaymentHistory();
            renderChart();
        }

        function renderPeople() {
            const group = getCurrentGroup();
            const list = document.getElementById('peopleList');
            if (group.people.length === 0) {
                list.innerHTML = '';
                return;
            }
            list.innerHTML = group.people.map(person => 
                '<div class="person-chip">' +
                '<span>' + escapeHtml(person) + '</span>' +
                (person !== currentUser ? '<button class="remove-person" onclick="removePerson(\'' + escapeHtml(person) + '\')">√ó</button>' : '') +
                '</div>'
            ).join('');
        }

        function renderWhoPaidDropdown() {
            const group = getCurrentGroup();
            const select = document.getElementById('whoPaid');
            if (group.people.length === 0) {
                select.innerHTML = '<option value="">No participants yet</option>';
                return;
            }
            select.innerHTML = group.people.map(person => 
                '<option value="' + escapeHtml(person) + '"' + (person === currentUser ? ' selected' : '') + '>' + escapeHtml(person) + '</option>'
            ).join('');
        }

        function renderExpenses() {
            const group = getCurrentGroup();
            const list = document.getElementById('expensesList');
            if (group.expenses.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-icon">üí∞</div><div class="empty-text">No expenses added yet</div></div>';
                return;
            }
            list.innerHTML = group.expenses.map(expense => 
                '<div class="expense-card">' +
                '<div class="expense-header">' +
                '<div>' +
                '<div class="expense-desc">' + escapeHtml(expense.description) + '</div>' +
                '<div class="expense-meta">Paid by ' + escapeHtml(expense.payer) + '</div>' +
                '</div>' +
                '<div class="expense-amount">' + formatCurrency(expense.amount) + '</div>' +
                '</div>' +
                '<div class="expense-actions">' +
                '<button class="icon-btn" onclick="editExpense(' + expense.id + ')">‚úèÔ∏è Edit</button>' +
                '<button class="icon-btn" onclick="deleteExpense(' + expense.id + ')">üóëÔ∏è Delete</button>' +
                '</div>' +
                '</div>'
            ).join('');
        }

        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        function showToast(icon, message) {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = '<span>' + icon + '</span><span>' + escapeHtml(message) + '</span>';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
